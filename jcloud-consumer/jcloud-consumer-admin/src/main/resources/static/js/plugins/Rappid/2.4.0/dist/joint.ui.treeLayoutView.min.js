/*! Rappid v2.4.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-07-01 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.TreeLayoutView=joint.mvc.View.extend({MINIMAL_PREVIEW_SIZE:10,className:"tree-layout",options:{previewAttrs:{parent:{rx:2,ry:2}},useModelGeometry:!1,clone:function(a){return a.clone()},canInteract:function(){return!0}},init:function(){joint.util.bindAll(this,"onPointermove","onPointerup"),this.toggleDefaultInteraction(!1),this.startListening(),this.render(),this.onSetTheme(null,this.theme)},startListening:function(){var a=this.options.paper;this.listenTo(a,"element:pointerdown",this.canInteract(this.onPointerdown))},toggleDefaultInteraction:function(a){this.options.paper.setInteractivity(a)},render:function(){var a=this.options.paper;return this.$activeBox=$("<div>").addClass("tree-layout-box active hidden").appendTo(this.el),this.draggingPaper=new joint.dia.Paper({model:new joint.dia.Graph,interactive:!1,width:"100%",height:"100%"}),this.$translateBox=$("<div>").addClass("tree-layout-box translate hidden").append(this.draggingPaper.render().el).appendTo(this.el),this.$mask=$("<div>").addClass("tree-layout-mask"),this.svgViewport=V(a.viewport),this.svgPreviewChild=V("circle").attr(this.options.previewAttrs.child||{}).addClass("tree-layout-preview child"),this.svgPreviewConnection=V("path").attr(this.options.previewAttrs.link||{}).addClass("tree-layout-preview link"),this.svgPreviewParent=V("rect").attr(this.options.previewAttrs.parent||{}).addClass("tree-layout-preview parent"),this.svgPreview=V("g").addClass("tree-layout-preview-group").append([this.svgPreviewConnection,this.svgPreviewParent,this.svgPreviewChild]),this.$el.appendTo(a.el),this},onSetTheme:function(a,b){var c=[this.svgPreview,this.$mask];c.forEach(function(c){c&&(a&&c.removeClass(this.themeClassNamePrefix+a),c.addClass(this.themeClassNamePrefix+b))},this)},onRemove:function(){this.svgPreview.remove()},toggleDropping:function(a){this.$mask.toggleClass("dropping-not-allowed",!a),this.$translateBox.toggleClass("no-drop",!a)},canDrop:function(){return this.isActive()&&!this.$translateBox.hasClass("no-drop")},isActive:function(){return!this.$translateBox.hasClass("hidden")},_startDrag:function(a,b,c){var d=this.options.paper;this.$mask.appendTo(d.el),this.toggleDropping(!1),this.ctm=d.matrix();var e=a[0],f=e.findView(d),g=f.getBBox({useModelGeometry:this.options.useModelGeometry});this.updateBox(this.$translateBox,joint.util.defaults({x:b,y:c},g)),this.updateBox(this.$activeBox,g),this.$activeBox.removeClass("hidden"),this.$translateBox.removeClass("hidden"),this.prepareDraggingPaper(e)},updateBox:function(a,b){a.css({width:b.width,height:b.height,left:b.x,top:b.y})},positionTranslateBox:function(a){var b=V.transformPoint(a,this.ctm);this.$translateBox.css({left:b.x,top:b.y})},prepareDraggingPaper:function(a){var b=this.options.clone(a).position(0,0);this.draggingPaper.scale(this.ctm.a,this.ctm.d),this.draggingPaper.model.resetCells([b])},_doDrag:function(a,b,c){var d,e,f=this.model,g={x:b,y:c};if(this.candidate&&(this.candidate=null,this.hidePreview()),this.positionTranslateBox(g),d=f.getMinimalRootAreaByPoint(g),d&&(e=d.findMinimalAreaByPoint(g,{expandBy:Math.min(f.get("siblingGap"),f.get("gap"))/2})),e){var h=this.findDirection(e,g),i=e.getLayoutSiblings(h),j=i.getSiblingRankByPoint(g),k=joint.util.toArray(a).every(function(a){return this.isConnectionValid(a,i,j)},this);k?(this.candidate={id:e.root.id,direction:h,siblingRank:j+.5},this.updatePreview(i,j),this.showPreview(),this.toggleDropping(!0)):this.toggleDropping(!1)}else this.toggleDropping(!0)},_finishDrag:function(a,b,c){this.$mask.remove().removeClass("dropping-not-allowed"),this.candidate?(a.forEach(function(a){this.reconnectElement(a,this.candidate)},this),this.candidate=null,this.model.layout({ui:!0})):this.canDrop()&&(a.forEach(function(a){this.translateElement(a,b,c)},this),this.model.layout({ui:!0})),this.$activeBox.addClass("hidden"),this.$translateBox.addClass("hidden"),this.hidePreview()},reconnectElement:function(a,b){var c={direction:b.direction,siblingRank:b.siblingRank,ui:!0},d=this.model.reconnectElement(a,b.id,c);if(!d){var e=this.options.paper,f=e.getDefaultLink(a.findView(e));f.set({source:{id:b.id},target:{id:a.id}}),f.addTo(e.model,c),this.model.changeSiblingRank(a,b.siblingRank,c),this.model.changeDirection(a,b.direction,c);var g=this.model.getAttribute(a,"direction");this.model.updateDirections(a,[g,b.direction],c)}},translateElement:function(a,b,c){var d=this.model.graph.getConnectedLinks(a,{inbound:!0});joint.util.invoke(d,"remove");var e=a.get("size");a.set("position",{x:b-e.width/2,y:c-e.height/2},{ui:!0})},updatePreview:function(a,b){var c=a.parentArea.root,d=Math.max(this.model.get("siblingGap")/2,this.MINIMAL_PREVIEW_SIZE),e={width:d,height:d},f=a.getNeighborPointFromRank(b),g=a.getConnectionPoints(f,{ignoreSiblings:!0}),h=a.getParentConnectionPoint(),i=a.getChildConnectionPoint(f,e);this.updateParentPreview(c.get("position"),c.get("size")),this.updateChildPreview(f,e),this.updateConnectionPreview(h,i,g)},showPreview:function(){this.svgViewport.append(this.svgPreview)},hidePreview:function(){this.svgPreview.remove()},updateParentPreview:function(a,b){this.svgPreviewParent.attr({x:a.x,y:a.y,width:b.width,height:b.height})},updateChildPreview:function(a,b){this.svgPreviewChild.attr({cx:a.x,cy:a.y,r:b.width/2})},updateConnectionPreview:function(a,b,c){this.svgPreviewConnection.attr({d:joint.connectors.rounded(a,b,c,{})})},findDirection:function(a,b){var c,d=a.root.get("layout")||a.getType();switch(d){case"BL-BR":case"TL-TR":case"L-R":return c=d.split("-"),b.x>a.rootCX?c[1]:c[0];case"BL-TL":case"BR-TR":case"B-T":return c=d.split("-"),b.y>a.rootCY?c[0]:c[1];case"L":case"R":case"T":case"B":case"TR":case"TL":case"BR":case"BL":return d;default:return a.direction}},isConnectionValid:function(a,b,c){if(a.id==b.parentArea.root.id)return!1;if(this.model.graph.isSuccessor(a,b.parentArea.root))return!1;var d=this.model.getLayoutArea(a);if(d.parentArea&&d.parentArea==b.parentArea&&d.direction==b.direction){var e=d.siblingRank-c;if(0===e||1===e)return!1}return!0},canInteract:function(a){return function(b){this.options.canInteract(b)&&a.apply(this,arguments)}.bind(this)},startDragging:function(a){var b=Array.isArray(a)?a:[a];joint.util.isEmpty(b)||(this._registerPointerEvents(),this._moveCounter=0,this._draggedElements=b)},onPointerdown:function(a){this.startDragging(a.model)},onPointermove:function(a){var b=this.options.paper,c=b.clientToLocalPoint({x:a.clientX,y:a.clientY});this._moveCounter===b.options.clickThreshold?this._startDrag(this._draggedElements,c.x,c.y):this._moveCounter>b.options.clickThreshold&&this._doDrag(this._draggedElements,c.x,c.y),this._moveCounter++},onPointerup:function(a){var b=this.options.paper;if(this._moveCounter>=b.options.clickThreshold){var c=b.clientToLocalPoint({x:a.clientX,y:a.clientY});this._finishDrag(this._draggedElements,c.x,c.y)}this._draggedElements=null,this._unregisterPointerEvents()},_registerPointerEvents:function(){var a=this.getEventNamespace();$(document).on("mousemove"+a+" touchmove"+a,this.onPointermove).on("mouseup"+a+" touchend"+a,this.onPointerup)},_unregisterPointerEvents:function(){$(document).off(this.getEventNamespace())}});