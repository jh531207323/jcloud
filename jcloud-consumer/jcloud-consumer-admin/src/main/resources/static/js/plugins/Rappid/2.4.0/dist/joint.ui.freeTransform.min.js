/*! Rappid v2.4.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-07-01 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.FreeTransform=joint.mvc.View.extend({className:"free-transform",events:{"mousedown .resize":"startResizing","mousedown .rotate":"startRotating","touchstart .resize":"startResizing","touchstart .rotate":"startRotating"},DIRECTIONS:["nw","n","ne","e","se","s","sw","w"],POSITIONS:["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"],options:{cellView:void 0,rotateAngleGrid:15,preserveAspectRatio:!1,minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0,allowOrthogonalResize:!0,allowRotation:!0,clearAll:!0,clearOnBlankPointerdown:!0},init:function(){var a=this.options;a.cellView?joint.util.defaults(a,{cell:a.cellView.model,paper:a.cellView.paper,graph:a.cellView.paper.model}):a.paper&&a.cell&&joint.util.defaults(a,{cellView:a.cell.findView(a.paper),graph:a.paper.model}),joint.util.bindAll(this,"update","remove","pointerup","pointermove");var b=a.paper,c=a.graph;a.clearAll&&this.constructor.clear(b),$(document.body).on("mousemove touchmove",this.pointermove),$(document).on("mouseup touchend",this.pointerup),this.listenTo(c,"all",this.update),this.listenTo(b,"scale translate",this.update),this.listenTo(c,"reset",this.remove),this.listenTo(a.cell,"remove",this.remove),a.clearOnBlankPointerdown&&this.listenTo(b,"blank:pointerdown",this.remove),b.$el.append(this.el),this.constructor.registerInstanceToPaper(this,b)},renderHandles:function(){var a=$("<div/>").prop("draggable",!1),b=a.clone().addClass("rotate"),c=this.POSITIONS.map(function(b){return a.clone().addClass("resize").attr("data-position",b)});this.$el.empty().append(c,b)},render:function(){this.renderHandles(),this.$el.attr("data-type",this.options.cell.get("type")),this.$el.toggleClass("no-orthogonal-resize",this.options.preserveAspectRatio||!this.options.allowOrthogonalResize),this.$el.toggleClass("no-rotation",!this.options.allowRotation),this.update()},update:function(){var a=this.options.paper.matrix(),b=this.options.cell.getBBox();b.x*=a.a,b.x+=a.e,b.y*=a.d,b.y+=a.f,b.width*=a.a,b.height*=a.d;var c=g.normalizeAngle(this.options.cell.get("angle")||0),d="rotate("+c+"deg)";this.$el.css({width:b.width+4,height:b.height+4,left:b.x-3,top:b.y-3,transform:d,"-webkit-transform":d,"-ms-transform":d});var e=Math.floor(c*(this.DIRECTIONS.length/360));if(e!=this._previousDirectionsShift){var f=this.DIRECTIONS.slice(e).concat(this.DIRECTIONS.slice(0,e));this.$(".resize").removeClass(this.DIRECTIONS.join(" ")).each(function(a,b){$(b).addClass(f[a])}),this._previousDirectionsShift=e}},calculateTrueDirection:function(a){var b=this.options.cell,c=g.normalizeAngle(b.get("angle")),d=this.POSITIONS.indexOf(a);return d+=Math.floor(c*(this.POSITIONS.length/360)),d%=this.POSITIONS.length,this.POSITIONS[d]},startResizing:function(a){a.stopPropagation(),this.options.graph.startBatch("free-transform",{freeTransform:this.cid});var b=$(a.target).data("position"),c=this.calculateTrueDirection(b),d=0,e=0;b.split("-").forEach(function(a){d={left:-1,right:1}[a]||d,e={top:-1,bottom:1}[a]||e});var f=this.toValidResizeDirection(b),h={"top-right":"bottomLeft","top-left":"corner","bottom-left":"topRight","bottom-right":"origin"}[f];this._initial={angle:g.normalizeAngle(this.options.cell.get("angle")||0),resizeX:d,resizeY:e,selector:h,direction:f,relativeDirection:b,trueDirection:c},this._action="resize",this.startOp(a.target)},toValidResizeDirection:function(a){return{top:"top-left",bottom:"bottom-right",left:"bottom-left",right:"top-right"}[a]||a},startRotating:function(a){a.stopPropagation(),this.options.graph.startBatch("free-transform",{freeTransform:this.cid});var b=this.options.cell.getBBox().center(),c=this.options.paper.snapToGrid({x:a.clientX,y:a.clientY});this._initial={centerRotation:b,modelAngle:g.normalizeAngle(this.options.cell.get("angle")||0),startAngle:g.point(c).theta(b)},this._action="rotate",this.startOp(a.target)},pointermove:function(a){if(this._action){a=joint.util.normalizeEvent(a);var b=this.options,c=b.paper.snapToGrid({x:a.clientX,y:a.clientY}),d=b.paper.options.gridSize,e=b.cell,f=this._initial;switch(this._action){case"resize":var h=e.getBBox(),i=g.point(c).rotate(h.center(),f.angle),j=i.difference(h[f.selector]()),k=f.resizeX?j.x*f.resizeX:h.width,l=f.resizeY?j.y*f.resizeY:h.height;if(k=g.snapToGrid(k,d),l=g.snapToGrid(l,d),k=Math.max(k,b.minWidth||d),l=Math.max(l,b.minHeight||d),k=Math.min(k,b.maxWidth),l=Math.min(l,b.maxHeight),b.preserveAspectRatio){var m=h.width*l/h.height,n=h.height*k/h.width;m>k?l=n:k=m}h.width==k&&h.height==l||e.resize(k,l,{freeTransform:this.cid,direction:f.direction,relativeDirection:f.relativeDirection,trueDirection:f.trueDirection,ui:!0,minWidth:b.minWidth,minHeight:b.minHeight,maxWidth:b.maxWidth,maxHeight:b.maxHeight,preserveAspectRatio:b.preserveAspectRatio});break;case"rotate":var o=f.startAngle-g.point(c).theta(f.centerRotation);e.rotate(g.snapToGrid(f.modelAngle+o,b.rotateAngleGrid),!0)}}},pointerup:function(a){this._action&&(this.stopOp(),this.options.graph.stopBatch("free-transform",{freeTransform:this.cid}),this._action=null,this._initial=null)},onRemove:function(){$(document.body).off("mousemove touchmove",this.pointermove),$(document).off("mouseup touchend",this.pointerup),joint.ui.FreeTransform.unregisterInstanceFromPaper(this,this.options.paper)},startOp:function(a){a&&($(a).addClass("in-operation"),this._elementOp=a),this.$el.addClass("in-operation"),this.options.paper.undelegateEvents()},stopOp:function(){this._elementOp&&($(this._elementOp).removeClass("in-operation"),this._elementOp=null),this.$el.removeClass("in-operation"),this.options.paper.delegateEvents()}},{instancesByPaper:{},clear:function(a){a.trigger("freetransform:create"),this.removeInstancesForPaper(a)},removeInstancesForPaper:function(a){joint.util.invoke(this.getInstancesForPaper(a),"remove")},getInstancesForPaper:function(a){return this.instancesByPaper[a.cid]||{}},registerInstanceToPaper:function(a,b){this.instancesByPaper[b.cid]||(this.instancesByPaper[b.cid]={}),this.instancesByPaper[b.cid][a.cid]=a},unregisterInstanceFromPaper:function(a,b){this.instancesByPaper[b.cid]&&(this.instancesByPaper[b.cid][a.cid]=null)}});