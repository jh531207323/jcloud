/*! Rappid v2.4.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-07-01 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.PathEditor=joint.mvc.View.extend({tagName:"g",svgElement:!0,className:"path-editor",events:{"mousedown .anchor-point":"onAnchorPointPointerDown","mousedown .control-point":"onControlPointPointerDown","mousedown .segment-path":"onSegmentPathPointerDown","touchstart .anchor-point":"onAnchorPointPointerDown","touchstart .control-point":"onControlPointPointerDown","touchstart .segment-path":"onSegmentPathPointerDown","dblclick .anchor-point":"onAnchorPointDoubleClick","dblclick .control-point":"onControlPointDoubleClick","dblclick .segment-path":"onSegmentPathDoubleClick"},documentEvents:{mousemove:"onPointerMove",touchmove:"onPointerMove",mouseup:"onPointerUp",touchend:"onPointerUp",touchcancel:"onPointerUp"},options:{anchorPointMarkup:'<circle r="2.5"/>',controlPointMarkup:'<circle r="2.5"/>'},init:function(){var a=this.pathNode=V(this.options.pathElement).normalizePath().node;this.segList=a.pathSegList,this.svgRoot=V(a.ownerSVGElement),this.$document=$(a.ownerDocument),this.render()},onRemove:function(){this.undelegateDocumentEvents(),this.clear()},clear:function(){var a=this.vel;a.empty(),this.directionPaths=[],this.segmentPaths=[],this.controlPoints=[],this.anchorPoints=[],this._subPathIndices=[0],this.trigger("clear",this.pathNode)},_transformPoint:function(a,b,c){return V.transformPoint(g.Point(a,b),c)},render:function(){this.clear();var a,b,c,d=this.vel,e=this.pathNode.getCTM(),f=V(this.options.anchorPointMarkup).addClass("anchor-point"),g=V(this.options.controlPointMarkup).addClass("control-point"),h=V('<path class="direction-path"/>'),i=V('<path class="segment-path"/>'),j=this.segList,k=this.anchorPoints,l=this.controlPoints,m=this.directionPaths,n=this.segmentPaths,o=this._subPathIndices;for(a=0,b=0,c=0;a<j.numberOfItems;a++){var p=j.getItem(a),q=this._transformPoint(p.x,p.y,e),r=q.x,s=q.y;if(p.pathSegType!=SVGPathSeg.PATHSEG_CLOSEPATH&&(k[a]=f.clone().attr({index:a,cx:r,cy:s})),p.pathSegType!=SVGPathSeg.PATHSEG_MOVETO_ABS){var t=i.clone().attr("index",a).node;switch(t.pathSegList.initialize(t.createSVGPathSegMovetoAbs(b,c)),p.pathSegType){case SVGPathSeg.PATHSEG_CLOSEPATH:var u=j.getItem(o[0]),v=this._transformPoint(u.x,u.y,e);r=v.x,s=v.y,t.pathSegList.appendItem(t.createSVGPathSegLinetoAbs(r,s)),o.unshift(a+1);break;case SVGPathSeg.PATHSEG_LINETO_ABS:t.pathSegList.appendItem(t.createSVGPathSegLinetoAbs(r,s));break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:var w=this._transformPoint(p.x1,p.y1,e),x=g.clone().attr({index:a,"attribute-index":1,cx:w.x,cy:w.y}),y=this._transformPoint(p.x2,p.y2,e),z=g.clone().attr({index:a,"attribute-index":2,cx:y.x,cy:y.y});l[a]=[x,z],t.pathSegList.appendItem(t.createSVGPathSegCurvetoCubicAbs(r,s,w.x,w.y,y.x,y.y)),m[a]=[h.clone().attr("d",["M",b,c,"L",w.x,w.y].join(" ")),h.clone().attr("d",["M",r,s,"L",y.x,y.y].join(" "))]}n[a]=t}b=r,c=s}var A=[];n.forEach(function(a){a&&A.push(a)}),m.forEach(function(a){a&&Array.prototype.push.apply(A,a)}),k.forEach(function(a){a&&A.push(a)}),l.forEach(function(a){a&&Array.prototype.push.apply(A,a)}),d.append(A),this.svgRoot.append(d)},startMoving:function(a){var b=joint.util.normalizeEvent(a),c=this.$point=$(b.target);this.prevClientX=b.clientX,this.prevClientY=b.clientY;var d=parseInt(this.$point.attr("index"),10);if(c.hasClass("anchor-point"))this.trigger("path:interact"),this.trigger("path:anchor-point:select",d);else if(c.hasClass("control-point")){var e=this.$point.attr("attribute-index");this.trigger("path:interact"),this.trigger("path:control-point:select",d,e)}else this.trigger("path:interact"),this.trigger("path:segment:select",d);b.stopPropagation(),b.preventDefault(),this.pathEditedEventType=null},move:function(a){var b=this.$point;if(b){var c=joint.util.normalizeEvent(a),d=c.clientX-this.prevClientX,e=c.clientY-this.prevClientY,f=parseInt(b.attr("index"),10);if(b.hasClass("anchor-point"))this.adjustAnchorPoint(f,d,e);else if(b.hasClass("control-point")){var g=b.attr("attribute-index");this.adjustControlPoint(f,g,d,e)}else this.adjustAnchorPoint(f-1,d,e),this.adjustAnchorPoint(f,d,e);this.prevClientX=c.clientX,this.prevClientY=c.clientY}},adjustControlPoint:function(a,b,c,d){var e=this.pathNode.getCTM(),f=this.segList,h=f.getItem(a),i=this.controlPoints,j=e.inverse();j.e=0,j.f=0;var k=this._transformPoint(c,d,j),l="x"+b,m="y"+b;h[l]+=k.x,h[m]+=k.y;var n=this._transformPoint(h[l],h[m],e),o=i[a][b-1].attr({cx:n.x,cy:n.y});if(o.hasClass("locked")){var p=this.getBoundIndex(a,b),q=1==b?2:1,r=f.getItem(p),s="x"+q,t="y"+q,u=g.point(1==b?r.x:h.x,1==b?r.y:h.y),v=g.point(h[l],h[m]),w=u.distance(g.Point(r[s],r[t])),x=u.move(v,w);r[s]=x.x,r[t]=x.y;var y=this._transformPoint(r[s],r[t],e);i[p][q-1].attr({cx:y.x,cy:y.y}),this.updateDirectionPaths(p),this.updateSegmentPath(p)}this.updateDirectionPaths(a),this.updateSegmentPath(a),this.pathEditedEventType="path:control-point:adjust"},findSubpathIndex:function(a){for(var b=this._subPathIndices,c=0,d=b.length;c<d;c++)if(b[c]<a)return b[c]},findReversedSubpathIndex:function(a){for(var b=this._subPathIndices,c=b.length-1;c>=0;c--)if(b[c]>a)return b[c]},adjustAnchorPoint:function(a,b,c){var d=this.pathNode.getCTM(),e=this.segList,f=e.getItem(a);f.pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH&&(a=this.findSubpathIndex(a),f=e.getItem(a));var g=this.anchorPoints,h=this.controlPoints,i=g.length-1;if((0===a||a===i)&&h[1]&&h[i]){var j=h[1][0],k=h[i][1];j&&j.hasClass("locked")&&j.removeClass("locked"),k&&k.hasClass("locked")&&k.removeClass("locked")}var l=d.inverse();l.e=0,l.f=0;var m=this._transformPoint(b,c,l);f.x+=m.x,f.y+=m.y;var n=this._transformPoint(f.x,f.y,d);if(g[a].attr({cx:n.x,cy:n.y}),f.pathSegType==SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS){f.x2+=m.x,f.y2+=m.y;var o=this._transformPoint(f.x2,f.y2,d);h[a][1].attr({cx:o.x,cy:o.y})}var p=a+1<e.numberOfItems?e.getItem(a+1):0;if(p){if(p.pathSegType==SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS){p.x1+=m.x,p.y1+=m.y;var q=this._transformPoint(p.x1,p.y1,d);h[a+1][0].attr({cx:q.x,cy:q.y}),this.updateDirectionPaths(a+1)}this.updateSegmentPath(a+1)}this.updateDirectionPaths(a),this.updateSegmentPath(a),this.pathEditedEventType="path:anchor-point:adjust"},updateDirectionPaths:function(a){var b=this.pathNode.getCTM(),c=this.segList,d=c.getItem(a),e=this._transformPoint(d.x,d.y,b),f=a>0?c.getItem(a-1):null,g=f?this._transformPoint(f.x,f.y,b):null,h=this.directionPaths[a];Array.isArray(h)&&h.forEach(function(a,c){c++;var h=this._transformPoint(d["x"+c],d["y"+c],b);a.attr("d",["M",c>1||!f?e.x:g.x,c>1||!f?e.y:g.y,h.x,h.y].join(" "))},this)},updateSegmentPath:function(a){var b=this.segList,c=this._subPathIndices;if(c.includes(a)){var d=this.findReversedSubpathIndex(a)||b.numberOfItems;if(d--,b.getItem(d).pathSegType!=SVGPathSeg.PATHSEG_CLOSEPATH)return;a=d}var e=this.segmentPaths[a];if(e){var f=this.pathNode.getCTM(),g=b.getItem(a-1),h=this._transformPoint(g.x,g.y,f),i=e.createSVGPathSegMovetoAbs(h.x,h.y);e.pathSegList.initialize(i);var j=b.getItem(a),k=this._transformPoint(j.x,j.y,f);switch(j.pathSegType){case SVGPathSeg.PATHSEG_CLOSEPATH:var l=b.getItem(this.findSubpathIndex(a)),m=this._transformPoint(l.x,l.y,f);i=e.createSVGPathSegLinetoAbs(m.x,m.y);break;case SVGPathSeg.PATHSEG_LINETO_ABS:i=e.createSVGPathSegLinetoAbs(k.x,k.y);break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:var n=this._transformPoint(j.x1,j.y1,f),o=this._transformPoint(j.x2,j.y2,f);i=e.createSVGPathSegCurvetoCubicAbs(k.x,k.y,n.x,n.y,o.x,o.y)}e.pathSegList.appendItem(i)}},stopMoving:function(){if(this.$point=null,this.pathEditedEventType){var a=this.pathNode;this.trigger("path:edit",a),this.trigger(this.pathEditedEventType,a)}this.pathEditedEventType=null},createAnchorPoint:function(a){var b=joint.util.normalizeEvent(a),c=V(b.target).attr("index"),d=this.pathNode,e=this.segList,f=V(d).toLocalPoint(b.pageX,b.pageY),h=e.getItem(c);switch(h.pathSegType){case SVGPathSeg.PATHSEG_CLOSEPATH:case SVGPathSeg.PATHSEG_LINETO_ABS:e.insertItemBefore(d.createSVGPathSegLinetoAbs(f.x,f.y),c);break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:var i=e.getItem(c-1),j=g.point(i.x,i.y),k=g.point(h.x1,h.y1),l=g.point(h.x2,h.y2),m=g.point(h.x,h.y),n=g.bezier.getInversionSolver(j,k,l,m)(f);if(n<0)return;var o=g.bezier.getCurveDivider(j,k,l,m)(n);e.insertItemBefore(d.createSVGPathSegCurvetoCubicAbs(o[0].p3.x,o[0].p3.y,o[0].p1.x,o[0].p1.y,o[0].p2.x,o[0].p2.y),c),h.x1=o[1].p1.x,h.y1=o[1].p1.y,h.x2=o[1].p2.x,h.y2=o[1].p2.y}this.render(),this.trigger("path:edit",d),this.trigger("path:anchor-point:create",d)},removeAnchorPoint:function(a){var b,c,d=joint.util.normalizeEvent(a),e=parseInt($(d.target).attr("index"),10),f=this.pathNode,g=this.segList,h=g.getItem(e);switch(h.pathSegType){case SVGPathSeg.PATHSEG_MOVETO_ABS:b=g.getItem(e+1),c=f.createSVGPathSegMovetoAbs(b.x,b.y),g.replaceItem(c,e+1),g.removeItem(e);break;case SVGPathSeg.PATHSEG_LINETO_ABS:g.removeItem(e);break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:e+1<=g.numberOfItems-1&&(b=g.getItem(e+1),b.pathSegType==SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS&&(b.x1=h.x1,b.y1=h.y1)),g.removeItem(e)}this.render(),this.trigger("path:edit",f),this.trigger("path:anchor-point:remove",f);var i=g.numberOfItems;g.getItem(g.numberOfItems-1).pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH&&(i-=1),i<2&&this.trigger("path:invalid",f)},lockControlPoint:function(a){var b=joint.util.normalizeEvent(a),c=$(b.target),d=this.pathNode,e=parseInt(c.attr("index")),f=c.attr("attribute-index"),g=this.getBoundIndex(e,f),h=1==f?2:1,i=this.controlPoints[g];if(i){var j=c.hasClass("locked");c.toggleClass("locked"),i[h-1].toggleClass("locked"),this.trigger("path:interact"),j?this.trigger("path:control-point:unlock",e,f):this.trigger("path:control-point:lock",e,f),this.adjustControlPoint(e,f,0,0),this.trigger("path:edit",d),this.trigger(this.pathEditedEventType,d),this.pathEditedEventType=null}},getBoundIndex:function(a,b){var c,d,e,f,g,h,i=this.segList,j=this.anchorPoints,k=j.length-1;return 1==b?(c=a-1,0===c&&(d=i.numberOfItems-1,e=i.getItem(d).pathSegType,f=e==SVGPathSeg.PATHSEG_CLOSEPATH,g=j[0].attr("cx")===j[k].attr("cx"),h=j[0].attr("cy")===j[k].attr("cy"),f&&g&&h&&(c=k))):(c=a+1,c===k+1&&(d=i.numberOfItems-1,e=i.getItem(d).pathSegType,f=e==SVGPathSeg.PATHSEG_CLOSEPATH,g=j[0].attr("cx")===j[k].attr("cx"),h=j[0].attr("cy")===j[k].attr("cy"),f&&g&&h&&(c=1))),c},getControlPointLockedStates:function(){for(var a=this.controlPoints,b=[],c=0;c<a.length;c++)if(a[c]){b[c]=[];for(var d=0;d<=1;d++)if(a[c][d]){var e=d+1;a[c][d].hasClass("locked")?b[c][e]=!0:b[c][e]=!1}}return b},setControlPointLockedStates:function(a){for(var b=this.controlPoints,c=0;c<b.length;c++)if(a[c]&&b[c])for(var d=1;d<=2;d++)a[c][d]&&b[c][d-1]&&(a[c][d]===!0?b[c][d-1].addClass("locked"):b[c][d-1].removeClass("locked"))},convertSegmentPath:function(a){var b,c,d=joint.util.normalizeEvent(a),e=V(d.target).attr("index"),f=this.pathNode,g=this.segList,h=g.getItem(e);switch(h.pathSegType){case SVGPathSeg.PATHSEG_CLOSEPATH:b=g.getItem(e-1),c=g.getItem(0),g.insertItemBefore(f.createSVGPathSegCurvetoCubicAbs(c.x,c.y,b.x,b.y,c.x,c.y),e);break;case SVGPathSeg.PATHSEG_LINETO_ABS:b=g.getItem(e-1),g.replaceItem(f.createSVGPathSegCurvetoCubicAbs(h.x,h.y,b.x,b.y,h.x,h.y),e);break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:g.replaceItem(f.createSVGPathSegLinetoAbs(h.x,h.y),e)}this.render(),this.trigger("path:edit",f),this.trigger("path:segment:convert",f)},addClosePathSegment:function(a){var b=joint.util.normalizeEvent(a),c=parseInt($(b.target).attr("index"),10),d=this.segList;if(0===c||c===d.numberOfItems-1){var e=d.getItem(d.numberOfItems-1);if(e.pathSegType!=SVGPathSeg.PATHSEG_CLOSEPATH){var f=this.pathNode;d.appendItem(f.createSVGPathSegClosePath()),this.render(),this.trigger("path:edit",f),this.trigger("path:closepath-segment:add",f)}}},removeClosePathSegment:function(a){var b=joint.util.normalizeEvent(a),c=V(b.target).attr("index"),d=this.segList,e=d.getItem(c);if(e.pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH){var f=this.pathNode;d.removeItem(c),this.render(),this.trigger("path:edit",f),this.trigger("path:closepath-segment:remove",f)}},onAnchorPointPointerDown:function(a){var b=joint.util.normalizeEvent(a);b.stopPropagation(),1===b.which&&(b.originalEvent.detail>1||(this.startMoving(b),this.delegateDocumentEvents()))},onControlPointPointerDown:function(a){var b=joint.util.normalizeEvent(a);b.stopPropagation(),1===b.which&&(b.originalEvent.detail>1||(this.startMoving(b),this.delegateDocumentEvents()))},onSegmentPathPointerDown:function(a){var b=joint.util.normalizeEvent(a);b.stopPropagation(),1===b.which&&(b.originalEvent.detail>1||(this.startMoving(b),this.delegateDocumentEvents()))},onPointerMove:function(a){var b=joint.util.normalizeEvent(a);b.stopPropagation(),this.move(b)},onPointerUp:function(a){this.undelegateDocumentEvents();var b=joint.util.normalizeEvent(a);b.stopPropagation(),this.stopMoving()},onAnchorPointDoubleClick:function(a){var b=joint.util.normalizeEvent(a);b.stopPropagation(),b.preventDefault(),1===b.which&&this.removeAnchorPoint(b)},onControlPointDoubleClick:function(a){var b=joint.util.normalizeEvent(a);b.stopPropagation(),b.preventDefault(),1===b.which&&this.lockControlPoint(b)},onSegmentPathDoubleClick:function(a){var b=joint.util.normalizeEvent(a);b.stopPropagation(),b.preventDefault(),1===b.which&&this.createAnchorPoint(b)}});