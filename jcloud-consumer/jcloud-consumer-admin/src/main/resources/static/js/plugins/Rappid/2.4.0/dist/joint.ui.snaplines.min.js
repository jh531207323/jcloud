/*! Rappid v2.4.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-07-01 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.Snaplines=joint.mvc.View.extend({options:{paper:void 0,distance:10},className:"snaplines",documentEvents:{mouseup:"hide",touchend:"hide"},init:function(){joint.util.bindAll(this,"hide"),this.render(),this.startListening(),this.prepareFilters()},render:function(){var a=this.$horizontal=$("<div>").addClass("snapline horizontal"),b=this.$vertical=$("<div>").addClass("snapline vertical");this.$el.hide().append([a,b]).appendTo(this.options.paper.el)},startListening:function(){this.stopListening(),this.listenTo(this.options.paper,"element:pointerdown",this.captureCursorOffset),this.listenTo(this.options.paper,"element:pointermove",this.snapWhileMoving),this.listenTo(this.options.paper.model,"batch:stop",this.onBatchStop),this.delegateDocumentEvents()},prepareFilters:function(){this.filterTypes={},this.filterCells={},this.filterFunction=void 0,Array.isArray(this.options.filter)?this.options.filter.forEach(function(a){joint.util.isString(a)?this.filterTypes[a]=!0:this.filterCells[a.id]=!0},this):joint.util.isFunction(this.options.filter)&&(this.filterFunction=this.options.filter)},onBatchStop:function(a){a=a||{},"resize"===a.batchName&&this.snapWhileResizing(a.cell,a)},captureCursorOffset:function(a,b,c,d){var e=a.getDelegatedView();if(e&&this.canElementMove(e)){var f=e.model.get("position");this._cursorOffset={x:c-f.x,y:d-f.y}}},snapWhileResizing:function(a,b){if(b.ui&&!b.snapped&&b.direction&&b.trueDirection){var c=this.options.paper.findViewByModel(a);if(c&&c.model.isElement()){var d=a.getBBox(),e=d.bbox(a.get("angle")),f=e.origin(),h=e.corner(),i=g.normalizeAngle(a.get("angle")),j=this.options.distance,k=null,l=null,m={vertical:0,horizontal:0},n=b.direction,o=b.trueDirection,p=b.relativeDirection;if(o.indexOf("right")!==-1?m.vertical=h.x:m.vertical=f.x,o.indexOf("bottom")!==-1?m.horizontal=h.y:m.horizontal=f.y,this.options.paper.model.getElements().find(function(b){if(b.id===a.id||b.isEmbeddedIn(a)||this.filterTypes[b.get("type")]||this.filterCells[b.id]||this.filterFunction&&this.filterFunction(b))return!1;var c=b.getBBox().bbox(b.get("angle")),d=c.origin(),e=c.corner(),f={vertical:[d.x,e.x],horizontal:[d.y,e.y]};return joint.util.forIn(f,function(a,b){a=a.map(function(a){return{position:a,distance:Math.abs(a-m[b])}}),a=a.filter(function(a){return a.distance<j}),a=joint.util.sortBy(a,function(a){return a.distance}),f[b]=a}),null===k&&f.vertical.length>0&&(k=f.vertical[0].position),null===l&&f.horizontal.length>0&&(l=f.horizontal[0].position),joint.util.isNumber(k)&&joint.util.isNumber(l)},this),this.hide(),joint.util.isNumber(k)||joint.util.isNumber(l)){var q=0;joint.util.isNumber(k)&&(q=o.indexOf("right")!==-1?k-e.corner().x:e.origin().x-k);var r=0;joint.util.isNumber(l)&&(r=o.indexOf("bottom")!==-1?l-e.corner().y:e.origin().y-l);var s=0,t=0,u=!(i%90);if(u)90===i||270===i?(s=r,t=q):(s=q,t=r);else{var v;v=i>=0&&i<90?1:i>=90&&i<180?4:i>=180&&i<270?3:2,l&&k&&(r>q?(r=0,l=null):(q=0,k=null));var w=g.toRad(i%90);q&&(s=3===v?q/Math.cos(w):q/Math.sin(w)),r&&(t=3===v?r/Math.cos(w):r/Math.sin(w));var x=1===v||3===v;switch(p){case"top":case"bottom":t=r?r/(x?Math.cos(w):Math.sin(w)):q/(x?Math.sin(w):Math.cos(w));break;case"left":case"right":s=q?q/(x?Math.cos(w):Math.sin(w)):r/(x?Math.sin(w):Math.cos(w))}}switch(p){case"top":case"bottom":s=0;break;case"left":case"right":t=0}var y=this.options.paper.options.gridSize,z=Math.max(d.width+s,y),A=Math.max(d.height+t,y);b.minWidth&&b.minWidth>y&&(z=Math.max(z,b.minWidth)),b.minHeight&&b.minHeight>y&&(A=Math.max(A,b.minHeight)),b.maxWidth&&(z=Math.min(z,b.maxWidth)),b.maxHeight&&(A=Math.min(A,b.maxHeight)),b.preserveAspectRatio&&(s>t?A=z*(d.height/d.width):z=A*(d.width/d.height)),z===d.width&&A===d.height||a.resize(z,A,{snaplines:this.cid,restrictedArea:this.options.paper.getRestrictedArea(c),direction:n,relativeDirection:p,trueDirection:o,snapped:!0});var B=a.getBBox().bbox(i),C=1;k&&Math.abs(B.x-k)>C&&Math.abs(B.width+B.x-k)>C&&(k=null),l&&Math.abs(B.y-l)>C&&Math.abs(B.height+B.y-l)>C&&(l=null),this.show({vertical:k,horizontal:l})}}}},canElementMove:function(a){return a&&a.model.isElement()&&a.can("elementMove")},snapWhileMoving:function(a,b,c,d){var e=a.eventData(b),f=e.delegatedView||a;if(this.canElementMove(f)){var h=f.model,i=h.get("position"),j=h.get("size"),k=g.rect(joint.util.assign({x:c-this._cursorOffset.x,y:d-this._cursorOffset.y},j)),l=k.center(),m=k.bbox(h.get("angle")),n=m.origin(),o=m.corner(),p=this.options.distance,q=null,r=null,s=0,t=0;if(this.options.paper.model.getElements().find(function(a){if(a===h||a.isEmbeddedIn(h)||this.filterTypes[a.get("type")]||this.filterCells[a.id]||this.filterFunction&&this.filterFunction(a))return!1;var b=a.getBBox().bbox(a.get("angle")),c=b.center(),d=b.origin(),e=b.corner();return null===q&&(Math.abs(c.x-l.x)<p?(q=c.x,s=.5):Math.abs(d.x-n.x)<p?q=d.x:Math.abs(d.x-o.x)<p?(q=d.x,s=1):Math.abs(e.x-o.x)<p?(q=e.x,s=1):Math.abs(e.x-n.x)<p&&(q=e.x)),null===r&&(Math.abs(c.y-l.y)<p?(r=c.y,t=.5):Math.abs(d.y-n.y)<p?r=d.y:Math.abs(d.y-o.y)<p?(r=d.y,t=1):Math.abs(e.y-o.y)<p?(r=e.y,t=1):Math.abs(e.y-n.y)<p&&(r=e.y)),joint.util.isNumber(q)&&joint.util.isNumber(r)},this),this.hide(),joint.util.isNumber(q)||joint.util.isNumber(r)){joint.util.isNumber(q)&&(m.x=q-s*m.width),joint.util.isNumber(r)&&(m.y=r-t*m.height);var u=m.center(),v=u.x-k.width/2,w=u.y-k.height/2;h.translate(v-i.x,w-i.y,{restrictedArea:this.options.paper.getRestrictedArea(f),snapped:!0}),this.show({vertical:q,horizontal:r})}}},show:function(a){a=a||{};var b=this.options.paper.matrix();a.horizontal?this.$horizontal.css("top",a.horizontal*b.d+b.f).show():this.$horizontal.hide(),a.vertical?this.$vertical.css("left",a.vertical*b.a+b.e).show():this.$vertical.hide(),this.$el.show()},hide:function(){this.$el.hide()}});